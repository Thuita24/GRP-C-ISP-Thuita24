{% extends "base.html" %}

{% block title %}Optimal Planting Time Calculator{% endblock %}

{% block content %}
<div class="container mt-4">
    
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h2>ğŸ—“ï¸ Optimal Planting Time Calculator</h2>
            <p class="text-muted">Find the best month to plant cotton based on predicted yields using transfer learning</p>
        </div>
    </div>

    <!-- Info Box -->
    <div class="alert alert-info" role="alert">
        <strong>â„¹ï¸ How it works:</strong> This tool uses your location's climate characteristics to predict cotton yields for each planting month. We then recommend the month with the highest predicted yield. The predictions are based on a transfer learning model trained on Indian cotton data and adapted for Kenya.
    </div>

    <!-- Quick Load Examples -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">ğŸ‡°ğŸ‡ª Quick Load: Kenya Counties</h5>
        </div>
        <div class="card-body">
            <p class="text-muted">Select a Kenya county to auto-fill typical values:</p>
            <select id="regionSelect" class="form-select form-select-lg" onchange="loadRegion(this.value)">
                <option value="">-- Select a Kenya County --</option>
                <option value="kenya_busia">ğŸŒ³ Kenya - Busia County (Humid, 1300mm)</option>
                <option value="kenya_machakos">ğŸŒ¾ Kenya - Machakos County (Semi-arid, 650mm)</option>
                <option value="kenya_siaya">ğŸŒ± Kenya - Siaya County (Sub-humid, 1200mm)</option>
                <option value="kenya_kitui">ğŸœï¸ Kenya - Kitui County (Arid, 500mm)</option>
                <option value="kenya_kakamega">ğŸŒ³ Kenya - Kakamega County (Humid, 1800mm)</option>
                <option value="kenya_makueni">ğŸŒ¾ Kenya - Makueni County (Semi-arid, 600mm)</option>
                <option value="kenya_embu">ğŸŒ± Kenya - Embu County (Sub-humid, 1000mm)</option>
                <option value="kenya_meru">ğŸŒ± Kenya - Meru County (Sub-humid, 1100mm)</option>
            </select>
        </div>
    </div>

    <!-- Main Form -->
    <form method="POST" action="{{ url_for('geographic.optimal_planting') }}">
        
        <!-- Hidden field to store location name -->
        <input type="hidden" name="location" id="locationName" value="{{ form_data.location if form_data else 'Unknown Location' }}">

        <!-- Location Information -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">ğŸ“ Location Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Location/County *</label>
                        <input type="text" class="form-control" id="locationInput" 
                               value="{{ form_data.name if form_data else '' }}" 
                               placeholder="e.g., Busia County, Kenya" readonly>
                        <small class="text-muted">Select from dropdown above to auto-fill</small>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Annual Rainfall (mm) *</label>
                        <input type="number" class="form-control" name="annual_rain" 
                               value="{{ form_data.annual_rain if form_data else '' }}" 
                               step="0.1" required placeholder="e.g., 1300">
                        <small class="text-muted">Total yearly rainfall for your location</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Climate Conditions -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">ğŸŒ¡ï¸ Climate Conditions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Average Temperature (Â°C) *</label>
                        <input type="number" class="form-control" name="temp_c" 
                               value="{{ form_data.temp_c if form_data else '' }}" 
                               step="0.1" required placeholder="e.g., 24">
                        <small class="text-muted">Annual average (20-30Â°C ideal)</small>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Dewpoint (Â°C) *</label>
                        <input type="number" class="form-control" name="dewpoint_c" 
                               value="{{ form_data.dewpoint_c if form_data else '' }}" 
                               step="0.1" required placeholder="e.g., 18">
                        <small class="text-muted">Typical dewpoint temperature</small>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Solar Radiation (MJ/mÂ²) *</label>
                        <input type="number" class="form-control" name="solar_rad" 
                               value="{{ form_data.solar_rad if form_data else '' }}" 
                               step="0.1" required placeholder="e.g., 17">
                        <small class="text-muted">Daily average (15-20 typical)</small>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Monthly Precipitation (mm) *</label>
                        <input type="number" class="form-control" name="precip_mm" 
                               value="{{ form_data.precip_mm if form_data else '' }}" 
                               step="0.1" required placeholder="e.g., 108">
                        <small class="text-muted">Average monthly rainfall</small>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Rainfall Variability (CV%) *</label>
                        <input type="number" class="form-control" name="rain_cv" 
                               value="{{ form_data.rain_cv if form_data else '20' }}" 
                               step="0.1" required placeholder="e.g., 20">
                        <small class="text-muted">Coefficient of variation (10-30 typical)</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Farm Characteristics -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">ğŸŒ¾ Farm Characteristics</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Soil Type *</label>
                        <select class="form-select" name="soil_type" required>
                            <option value="">-- Select Soil Type --</option>
                            <option value="Black" {% if form_data and form_data.soil_type == 'Black' %}selected{% endif %}>Black Soil</option>
                            <option value="Red" {% if form_data and form_data.soil_type == 'Red' %}selected{% endif %}>Red Soil</option>
                            <option value="Alluvial" {% if form_data and form_data.soil_type == 'Alluvial' %}selected{% endif %}>Alluvial Soil</option>
                        </select>
                        <small class="text-muted">Primary soil type on your farm</small>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Irrigation Coverage (%) *</label>
                        <input type="number" class="form-control" name="irrigation" 
                               value="{{ form_data.irrigation if form_data else '' }}" 
                               step="0.1" min="0" max="100" required placeholder="e.g., 15">
                        <small class="text-muted">Percentage of farm with irrigation (0-100)</small>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Previous Yield (bales/ha)</label>
                        <input type="number" class="form-control" name="prev_yield" 
                               value="{{ form_data.prev_yield if form_data else '1.5' }}" 
                               step="0.1" placeholder="e.g., 1.5">
                        <small class="text-muted">Last season's yield (optional, default: 1.5)</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="row mb-5">
            <div class="col-md-6 offset-md-3">
                <button type="submit" class="btn btn-primary btn-lg w-100">
                    ğŸ—“ï¸ Calculate Optimal Planting Time
                </button>
            </div>
        </div>

    </form>

</div>

<script>
function loadRegion(regionName) {
    if (regionName) {
        // Get the selected option's display text
        const selectElement = document.getElementById('regionSelect');
        const selectedText = selectElement.options[selectElement.selectedIndex].text;
        
        // Remove emojis and extra info in parentheses
        const cleanLocation = selectedText.replace(/ğŸŒ³|ğŸŒ±|ğŸŒ¾|ğŸœï¸/g, '').split('(')[0].trim();
        
        // Store in sessionStorage
        sessionStorage.setItem('selectedLocation', cleanLocation);
        
        // Redirect to load example data
        window.location.href = "{{ url_for('geographic.load_example', example_name='') }}" + regionName;
    }
}

// On page load, restore location name
document.addEventListener('DOMContentLoaded', function() {
    const storedLocation = sessionStorage.getItem('selectedLocation');
    if (storedLocation) {
        document.getElementById('locationName').value = storedLocation;
        document.getElementById('locationInput').value = storedLocation;
    }
    
    // Clear after use
    sessionStorage.removeItem('selectedLocation');
});
</script>

<style>
.card {
    border-radius: 10px;
}

.card-header {
    border-radius: 10px 10px 0 0 !important;
}

.form-label {
    font-weight: 600;
    color: #333;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    padding: 15px;
    font-size: 1.1rem;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}
</style>
{% endblock %}